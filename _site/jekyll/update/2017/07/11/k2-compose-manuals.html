<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>k2-compose Manuals</title>
  <meta name="description" content="简介k2-compose集成了docker-compose==1.7.1的基础功能，包括up、stop、start、restart、rm、logs、pull">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/jekyll/update/2017/07/11/k2-compose-manuals.html">
  <link rel="alternate" type="application/rss+xml" title="Hippopo" href="http://localhost:4000/feed.xml">
</head>


  <body>
      <div class="outer">
        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Hippopo</a>
    
  </div>

  <div class="header-badge">
    <a href="/">
        <img src="/static/img/header.jpg" />
    </a>
  </div>
    
</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">k2-compose Manuals</h1>
    <p class="post-meta"><time datetime="2017-07-11T01:01:19+08:00" itemprop="datePublished">Jul 11, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h4 id="简介">简介</h4>
<p>k2-compose集成了docker-compose==1.7.1的基础功能，包括</p>

<div class="highlighter-rouge"><pre class="highlight"><code>up、stop、start、restart、rm、logs、pull
</code></pre>
</div>

<p>优化增加了以下功能</p>

<div class="highlighter-rouge"><pre class="highlight"><code>inspect、ps、bash、show、save	
</code></pre>
</div>

<p>配置文件支持docker-compose原生、k2-compose定制化，这两种配置文件格式。</p>

<h4 id="特点">特点</h4>
<p>相对于docker-compose，另外还支持：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1. 主机列表
2. 容器列表
3. 容器指定运行主机
4. 容器依赖关系
5. 容器健康检查
6. 容器镜像的信息检测
</code></pre>
</div>

<h4 id="k2-compose文件示例">k2-compose文件示例</h4>
<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2"</span>
<span class="s">hosts</span><span class="pi">:</span>
  <span class="s">as</span><span class="pi">:</span> <span class="s">localhost:4243</span>

<span class="s">project</span><span class="pi">:</span> <span class="s">k2-compose-test</span>

<span class="s">services</span><span class="pi">:</span>

  <span class="s">busybox1</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">busybox:latest</span>
    <span class="s">health_check</span><span class="pi">:</span>
      <span class="s">shell</span><span class="pi">:</span> <span class="s">echo "ok." &amp;&amp; exit 0</span>
      <span class="s">timeout</span><span class="pi">:</span> <span class="s">10</span>
    <span class="s">entrypoint</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">ping"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">localhost"</span><span class="pi">]</span>

  <span class="s">busybox2</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">busybox:latest</span>
    <span class="s">host</span><span class="pi">:</span> <span class="s">as</span>
    <span class="s">health_check</span><span class="pi">:</span>
      <span class="s">shell</span><span class="pi">:</span> <span class="s">echo "ok." &amp;&amp; exit 1</span>
      <span class="s">timeout</span><span class="pi">:</span> <span class="s">10</span>
    <span class="s">entrypoint</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">ping"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">localhost"</span><span class="pi">]</span>
    <span class="s">s_depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">busybox1</span>
</code></pre>
</div>
<p>上述例子中hosts、project、host、health_check、s_depends_on是k2-compose专有字段，</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">字段</th>
      <th style="text-align: left">描述</th>
      <th style="text-align: left">类型</th>
      <th style="text-align: left">required</th>
      <th style="text-align: left">缺省默认值</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">hosts</td>
      <td style="text-align: left">主机列表</td>
      <td style="text-align: left">object</td>
      <td style="text-align: left">false</td>
      <td style="text-align: left">“local”:”127.0.0.1:4243”</td>
    </tr>
    <tr>
      <td style="text-align: left">project</td>
      <td style="text-align: left">项目名称</td>
      <td style="text-align: left">string</td>
      <td style="text-align: left">false</td>
      <td style="text-align: left">“k2-compose”</td>
    </tr>
    <tr>
      <td style="text-align: left">services.service.host</td>
      <td style="text-align: left">容器运行主机名，必须在hosts里定义</td>
      <td style="text-align: left">string</td>
      <td style="text-align: left">false</td>
      <td style="text-align: left">local</td>
    </tr>
    <tr>
      <td style="text-align: left">services.service.s_depends_on</td>
      <td style="text-align: left">依赖的容器列表</td>
      <td style="text-align: left">array</td>
      <td style="text-align: left">false</td>
      <td style="text-align: left">空</td>
    </tr>
    <tr>
      <td style="text-align: left">services.service.health_check</td>
      <td style="text-align: left">健康检查命令属性</td>
      <td style="text-align: left">object</td>
      <td style="text-align: left">false</td>
      <td style="text-align: left">空（健康）</td>
    </tr>
    <tr>
      <td style="text-align: left">services.service.health_check.shell</td>
      <td style="text-align: left">检查命令shell格式</td>
      <td style="text-align: left">string or string数组</td>
      <td style="text-align: left">false</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">services.service.health_check.timeout</td>
      <td style="text-align: left">检查命令超时时间</td>
      <td style="text-align: left">int(单位s)</td>
      <td style="text-align: left">false</td>
      <td style="text-align: left">10</td>
    </tr>
  </tbody>
</table>

<h3 id="操作示例">操作示例</h3>
<p>注</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1. 以下k2-compose.yml就是“k2-compose文件示例”的内容。
2. 以下所有的命令（除了rm、logs、bash外）都可以接受具体的service名称，也可以缺省，默认是所有的service,如：k2-compose ps busybox1。
3. k2-compose -f k2-compose.yml，-f接受配置文件，缺省默认是k2-compose.yml, 以下示例都省略-f k2-compose.yml。
4. Image-Status的值只有在镜像有变化时才会提示。
</code></pre>
</div>

<h4 id="show">show</h4>
<p>show 有两种状态，</p>

<ol>
  <li>show配置文件的拓扑图；</li>
  <li>show service的配置信息；</li>
</ol>

<div class="highlighter-rouge"><pre class="highlight"><code>root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml show
┌k2-compose.yml──────────┬────────────┐
│ host  │ dockerHost     │ services   │
├───────┼────────────────┼────────────┤
│ as    │ localhost:4243 │ - busybox2 │
├───────┼────────────────┼────────────┤
│ local │ 127.0.0.1:4243 │ - busybox1 │
└───────┴────────────────┴────────────┘
root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml show busybox1
┌busybox1──────┬─────────────────────────────┐
│ entrypoint   │ - ping                      │
│              │ - localhost                 │
├──────────────┼─────────────────────────────┤
│ health_check │ shell: echo "ok." &amp;&amp; exit 0 │
│              │ timeout: 10                 │
├──────────────┼─────────────────────────────┤
│ image        │ busybox:latest              │
└──────────────┴─────────────────────────────┘
</code></pre>
</div>

<h4 id="ps">ps</h4>
<p>查看service状态；</p>

<p>这时候容器还没有部署，Service-Status显示的是undeployed，busybox2依赖于busybox1</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">root@minion1:~/k2-compose-0.0.4rc1/tests# </span>k2-compose -f k2-compose.yml  ps
+----------+----------------+----------------+--------------+------------+-------+--------------+
| Service  | Host           | Service-Status | Image-Status | Depends-On | Ports | Network-Mode |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox1 | 127.0.0.1:4243 | undeployed     |              |            |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox2 | localhost:4243 | undeployed     |              | - busybox1 |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
</code></pre>
</div>

<h4 id="up">up</h4>
<p>启动service，如果镜像不存在的话，会先pull镜像；</p>

<p>-d 参数是让容器在后台启动；</p>

<p>在“k2-compose文件示例”中busybox2的health_check的shell脚本返回值是1（非0），所以busybox2的Service-Status状态是error。</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">root@minion1:~/k2-compose-0.0.4rc1/tests# </span>k2-compose -f k2-compose.yml up -d
Creating k2composetest_busybox1_1
Creating k2composetest_busybox2_1
<span class="gp">root@minion1:~/k2-compose-0.0.4rc1/tests# </span>k2-compose -f k2-compose.yml ps
+----------+----------------+----------------+--------------+------------+-------+--------------+
| Service  | Host           | Service-Status | Image-Status | Depends-On | Ports | Network-Mode |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox1 | 127.0.0.1:4243 | running        |              |            |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox2 | localhost:4243 | error          |              | - busybox1 |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
</code></pre>
</div>

<h4 id="stop">stop</h4>
<p>停止service</p>

<div class="highlighter-rouge"><pre class="highlight"><code>root@minion1:~/k2-compose-0.0.4rc1/tests# k2-compose -f k2-compose.yml stop
Going to stop ALL-Services. Are you sure? [yN] y
Stopping [busybox2] ...
Done.
Stopping [busybox1] ...
Done.
root@minion1:~/k2-compose-0.0.4rc1/tests# k2-compose -f k2-compose.yml ps
+----------+----------------+----------------+--------------+------------+-------+--------------+
| Service  | Host           | Service-Status | Image-Status | Depends-On | Ports | Network-Mode |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox1 | 127.0.0.1:4243 | stopped        |              |            |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox2 | localhost:4243 | stopped        |              | - busybox1 |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
</code></pre>
</div>

<h4 id="start">start</h4>
<p>启动service</p>

<div class="highlighter-rouge"><pre class="highlight"><code>root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml start
Starting [busybox1] ...
Done.
Starting [busybox2] ...
Done.
root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml ps
+----------+----------------+----------------+--------------+------------+-------+--------------+
| Service  | Host           | Service-Status | Image-Status | Depends-On | Ports | Network-Mode |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox1 | 127.0.0.1:4243 | running        |              |            |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox2 | localhost:4243 | error          |              | - busybox1 |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
</code></pre>
</div>

<h4 id="restart">restart</h4>
<p>重启service</p>

<div class="highlighter-rouge"><pre class="highlight"><code>root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml restart
Stopping [busybox1] ...
Done.
Starting [busybox1] ...
Done.
Stopping [busybox2] ...
Done.
Starting [busybox2] ...
Done.
root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml ps
+----------+----------------+----------------+--------------+------------+-------+--------------+
| Service  | Host           | Service-Status | Image-Status | Depends-On | Ports | Network-Mode |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox1 | 127.0.0.1:4243 | running        |              |            |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox2 | localhost:4243 | error          |              | - busybox1 |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
</code></pre>
</div>

<h4 id="logs">logs</h4>
<p>查看service log</p>

<p>logs 必须指定service名称，支持-f参数，持续显示容器log</p>

<div class="highlighter-rouge"><pre class="highlight"><code>root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml logs busybox1
Attaching to k2composetest_busybox1_1
busybox1_1  | PING localhost (127.0.0.1): 56 data bytes
busybox1_1  | 64 bytes from 127.0.0.1: seq=0 ttl=64 time=0.039 ms
busybox1_1  | 64 bytes from 127.0.0.1: seq=1 ttl=64 time=0.032 ms
busybox1_1  | 64 bytes from 127.0.0.1: seq=2 ttl=64 time=0.049 ms
busybox1_1  | 64 bytes from 127.0.0.1: seq=3 ttl=64 time=0.036 ms
busybox1_1  | 64 bytes from 127.0.0.1: seq=4 ttl=64 time=0.049 ms
busybox1_1  | 64 bytes from 127.0.0.1: seq=5 ttl=64 time=0.035 ms
busybox1_1  | 64 bytes from 127.0.0.1: seq=6 ttl=64 time=0.037 ms
busybox1_1  | 64 bytes from 127.0.0.1: seq=7 ttl=64 time=0.037 ms
busybox1_1  | 64 bytes from 127.0.0.1: seq=8 ttl=64 time=0.036 ms
busybox1_1  | 64 bytes from 127.0.0.1: seq=9 ttl=64 time=0.038 ms
busybox1_1  | 64 bytes from 127.0.0.1: seq=10 ttl=64 time=0.034 ms
</code></pre>
</div>

<h4 id="pull">pull</h4>
<p>更新service镜像；</p>

<p>如果有镜像更新，Image-Status会有变化</p>

<div class="highlighter-rouge"><pre class="highlight"><code>root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml pull
Going to update ALL-Services Images. Are you sure? [yN] y
Pulling busybox1 (busybox:latest)...
latest: Pulling from library/busybox
27144aa8f1b9: Pull complete
Digest: sha256:be3c11fdba7cfe299214e46edc642e09514dbb9bbefcd0d3836c05a1e0cd0642
Status: Downloaded newer image for busybox:latest
Pulling busybox2 (busybox:latest)...
latest: Pulling from library/busybox
Digest: sha256:be3c11fdba7cfe299214e46edc642e09514dbb9bbefcd0d3836c05a1e0cd0642
Status: Image is up to date for busybox:latest
root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml ps
+----------+----------------+----------------+--------------+------------+-------+--------------+
| Service  | Host           | Service-Status | Image-Status | Depends-On | Ports | Network-Mode |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox1 | 127.0.0.1:4243 | running        | changed      |            |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox2 | localhost:4243 | error          | changed      | - busybox1 |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
</code></pre>
</div>

<h4 id="bash">bash</h4>
<p>进入容器；</p>

<p>用的sh,可以手动切换成/bin/bash</p>

<div class="highlighter-rouge"><pre class="highlight"><code>root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml bash busybox1
#####In [busybox1] Container#####
/ # ls
bin   dev   etc   home  proc  root  sys   tmp   usr   var
/ # exit
#####Out [busybox1] Container#####
</code></pre>
</div>

<h4 id="inspect">inspect</h4>
<p>检查service的镜像信息，如果容器使用的镜像有变化的话，会显示!(NOT MATCH)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml inspect
┌k2-compose.yml──┬──────────┬──────────────┬─────────────────────┬────────┐
│ Image          │ Service  │ Image-Id     │ Created             │ Labels │
├────────────────┼──────────┼──────────────┼─────────────────────┼────────┤
│ busybox:latest │ busybox2 │ 00f017a8c2a6 │ 2017-03-09T18:28:04 │        │
│ !(NOT MATCH)   │          │              │                     │        │
├────────────────┼──────────┼──────────────┼─────────────────────┼────────┤
│ busybox:latest │ busybox1 │ c30178c5239f │ 2017-06-15T20:42:30 │        │
│                │          │              │                     │        │
└────────────────┴──────────┴──────────────┴─────────────────────┴────────┘
</code></pre>
</div>

<h4 id="save">save</h4>
<p>镜像管理工具，非专业人士慎用；此命令将符合Match状态的service的镜像tag后面加一个suffix，然后推送到镜像库</p>

<p>默认是手动选择模式，–no-interaction非交互模式</p>

<div class="highlighter-rouge"><pre class="highlight"><code>root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml save --suffix test
 Please choose your images for save (press SPACE to mark, ENTER to continue, Ctrl+C to exit):
   Image          | Service  | Image-Id     | Match
   -------------------------------------------------------

 * busybox:latest | busybox1 | c30178c5239f |
   busybox:latest | busybox2 | 00f017a8c2a6 | !(NOT MATCH)

root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml save --suffix test  --no-interaction
List:
do              busybox:latest =&gt; busybox:latesttest
skip(not match) busybox:latest =&gt; busybox:latesttest
Tag and Push these images.
These service`s image is not ready, please fix it first.
┌Not Ready───────┬──────────┬──────────────┬─────────────────────┬────────┐
│ Image          │ Service  │ Image-Id     │ Created             │ Labels │
├────────────────┼──────────┼──────────────┼─────────────────────┼────────┤
│ busybox:latest │ busybox2 │ 00f017a8c2a6 │ 2017-03-09T18:28:04 │        │
│ !(NOT MATCH)   │          │              │                     │        │
└────────────────┴──────────┴──────────────┴─────────────────────┴────────┘
</code></pre>
</div>

<h4 id="rm">rm</h4>
<p>删除service时，service必须在stopped状态，然后才能被删除，或者使用-f参数强制删除。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml rm busybox1
Removing [busybox1] ...
ERROR: 409 Client Error: Conflict
root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml rm -f busybox1
Removing [busybox1] ...
Done.
root@minion1:~/k2-compose-0.0.4rc2/tests# k2-compose -f k2-compose.yml ps
+----------+----------------+----------------+--------------+------------+-------+--------------+
| Service  | Host           | Service-Status | Image-Status | Depends-On | Ports | Network-Mode |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox1 | 127.0.0.1:4243 | undeployed     |              |            |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
| busybox2 | localhost:4243 | error          | changed      | - busybox1 |       | default      |
+----------+----------------+----------------+--------------+------------+-------+--------------+
</code></pre>
</div>

<h3 id="troubleshooting">Troubleshooting</h3>

<ol>
  <li>安装过程中由于docker-compose==1.7.1要求的requests&gt;=2.6 &lt;2.8,如果本地requests版本不对，需要先重新安装requests: pip install requests==2.7</li>
</ol>

  </div>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">Hippopo</span>

  </div>

</footer>

      </div>
  </body>
  
</html>
